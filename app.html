<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - BloodAid</title>
    <link rel="stylesheet" href="styles/app.css">
    <link rel="stylesheet" href="styles/blockchain.css">
    <script src="scripts/sidebar.js" defer></script>
</head>
<body>
    <div id="sidebar-container"></div>

    <main class="content">
        <div class="dashboard-header">
            <h1>Dashboard</h1>
            <p class="welcome-message">Welcome to BloodAid - Your platform for safe blood donation</p>
        </div>

        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon">ü©∏</div>
                <div class="stat-info">
                    <h3>Available Donors</h3>
                    <span class="stat-number" id="donors-count">0</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-info">
                    <h3>Verified Today</h3>
                    <span class="stat-number" id="verified-count">0</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üö®</div>
                <div class="stat-info">
                    <h3>Active Emergencies</h3>
                    <span class="stat-number" id="emergencies-count">0</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üîó</div>
                <div class="stat-info">
                    <h3>Blockchain Status</h3>
                    <span class="stat-status active">Connected</span>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h2>Quick Actions</h2>
            <div class="action-grid">
                <a href="profile.html" class="action-card">
                    <div class="action-icon">üë§</div>
                    <h3>My Profile</h3>
                    <p>Update your information and verification status</p>
                </a>

                <a href="donors.html" class="action-card">
                    <div class="action-icon">üîç</div>
                    <h3>Find Donors</h3>
                    <p>Search for verified blood donors</p>
                </a>

                <a href="emergency.html" class="action-card">
                    <div class="action-icon">üö®</div>
                    <h3>Emergency Request</h3>
                    <p>Send urgent blood requirement alerts</p>
                </a>

                <a href="map.html" class="action-card">
                    <div class="action-icon">üó∫Ô∏è</div>
                    <h3>Donor Map</h3>
                    <p>View donors in your area</p>
                </a>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="recent-activity">
            <div class="activity-header">
                <h2>Recent Activity</h2>
                <button onclick="refreshActivity()" class="refresh-btn">Refresh</button>
            </div>
            <div id="recentActivity" class="activity-list">
                <div class="loading-activity">
                    <p>Loading recent activity...</p>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="system-status">
            <h2>System Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-dot active"></span>
                    <span>Blockchain Network</span>
                </div>
                <div class="status-item">
                    <span class="status-dot active"></span>
                    <span>Donor Database</span>
                </div>
                <div class="status-item">
                    <span class="status-dot active"></span>
                    <span>Emergency System</span>
                </div>
                <div class="status-item">
                    <span class="status-dot active"></span>
                    <span>Verification Service</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Load dashboard data
        function loadDashboardData() {
            updateStats();
            loadRecentActivity();
        }

        function updateStats() {
            // Donors count
            const registeredDonors = JSON.parse(localStorage.getItem('registeredDonors') || '[]');
            document.getElementById('donors-count').textContent = registeredDonors.length;

            // Verified today (count verifications from today)
            const verifications = JSON.parse(localStorage.getItem('profileVerifications') || '[]');
            const today = new Date().toDateString();
            const todayVerifications = verifications.filter(v => 
                new Date(v.timestamp).toDateString() === today
            );
            document.getElementById('verified-count').textContent = todayVerifications.length;

            // Active emergencies
            const emergencies = JSON.parse(localStorage.getItem('emergencyRequests') || '[]');
            const activeEmergencies = emergencies.filter(e => e.status === 'active');
            document.getElementById('emergencies-count').textContent = activeEmergencies.length;
        }

        function loadRecentActivity() {
            const activityElement = document.getElementById('recentActivity');
            
            // Get recent activities from different sources
            const emergencies = JSON.parse(localStorage.getItem('emergencyRequests') || '[]');
            const verifications = JSON.parse(localStorage.getItem('profileVerifications') || '[]');
            const donors = JSON.parse(localStorage.getItem('registeredDonors') || '[]');

            // Combine and sort by timestamp
            let allActivities = [];

            // Add emergency activities
            emergencies.slice(-3).forEach(emergency => {
                allActivities.push({
                    type: 'emergency',
                    message: `Emergency request for ${emergency.bloodType} blood`,
                    timestamp: emergency.timestamp,
                    icon: 'üö®'
                });
            });

            // Add verification activities
            verifications.slice(-3).forEach(verification => {
                allActivities.push({
                    type: 'verification',
                    message: `${verification.type.replace('_', ' ')} completed`,
                    timestamp: verification.timestamp,
                    icon: '‚úÖ'
                });
            });

            // Add donor registration activities
            donors.slice(-2).forEach(donor => {
                allActivities.push({
                    type: 'donor',
                    message: `${donor.name} registered as donor`,
                    timestamp: donor.registeredAt || new Date().toISOString(),
                    icon: 'üë§'
                });
            });

            // Sort by timestamp (newest first) and take latest 5
            allActivities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const recentActivities = allActivities.slice(0, 5);

            if (recentActivities.length > 0) {
                activityElement.innerHTML = recentActivities.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon">${activity.icon}</div>
                        <div class="activity-details">
                            <p class="activity-message">${activity.message}</p>
                            <span class="activity-time">${formatTimeAgo(activity.timestamp)}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                activityElement.innerHTML = `
                    <div class="no-activity">
                        <p>No recent activity yet</p>
                        <p class="activity-hint">Complete your profile or search for donors to see activity here</p>
                    </div>
                `;
            }
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const activityTime = new Date(timestamp);
            const diffMinutes = Math.floor((now - activityTime) / (1000 * 60));
            
            if (diffMinutes < 1) return 'Just now';
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h ago`;
            return `${Math.floor(diffMinutes / 1440)}d ago`;
        }

        function refreshActivity() {
            const refreshBtn = document.querySelector('.refresh-btn');
            refreshBtn.textContent = 'Refreshing...';
            
            setTimeout(() => {
                loadDashboardData();
                refreshBtn.textContent = 'Refresh';
                
                // Show refresh confirmation
                const activityElement = document.getElementById('recentActivity');
                const originalContent = activityElement.innerHTML;
                
                activityElement.innerHTML = `
                    <div class="refresh-confirm">
                        <p>‚úÖ Activity updated</p>
                    </div>
                `;
                
                setTimeout(() => {
                    activityElement.innerHTML = originalContent;
                }, 1000);
            }, 800);
        }

        // Check if user has completed profile
        function checkUserProfile() {
            const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            if (!profile.name) {
                showProfileReminder();
            }
        }

        function showProfileReminder() {
            const reminder = document.createElement('div');
            reminder.className = 'profile-reminder';
            reminder.innerHTML = `
                <div class="reminder-content">
                    <h3>Complete Your Profile</h3>
                    <p>Finish setting up your profile to access all features</p>
                    <a href="profile.html" class="reminder-btn">Go to Profile</a>
                </div>
            `;
            
            document.querySelector('.content').insertBefore(reminder, document.querySelector('.stats-overview'));
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            checkUserProfile();
            
            // Update stats every 30 seconds
            setInterval(updateStats, 30000);
        });
    </script>

    <style>
        .dashboard-header {
            margin-bottom: 30px;
        }

        .dashboard-header h1 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 2.2em;
        }

        .welcome-message {
            color: #666;
            font-size: 1.1em;
            margin: 0;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 2.5em;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .stat-info h3 {
            margin: 0 0 8px 0;
            color: #666;
            font-size: 0.9em;
            font-weight: 500;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            display: block;
        }

        .stat-status {
            font-size: 1.1em;
            font-weight: 600;
            color: #28a745;
        }

        .quick-actions {
            margin-bottom: 40px;
        }

        .quick-actions h2 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 1.5em;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .action-card {
            background: white;
            padding: 30px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-decoration: none;
            color: inherit;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-color: #ff4757;
        }

        .action-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .action-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.3em;
        }

        .action-card p {
            margin: 0;
            color: #666;
            line-height: 1.5;
        }

        .recent-activity {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .activity-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5em;
        }

        .refresh-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: #5a6268;
        }

        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .activity-item {
            display: flex;
            align-items: start;
            gap: 15px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .activity-icon {
            font-size: 1.2em;
            margin-top: 2px;
        }

        .activity-details {
            flex: 1;
        }

        .activity-message {
            margin: 0 0 5px 0;
            color: #333;
            font-weight: 500;
        }

        .activity-time {
            color: #666;
            font-size: 0.9em;
        }

        .loading-activity,
        .no-activity {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .activity-hint {
            font-size: 0.9em;
            margin-top: 10px;
        }

        .refresh-confirm {
            text-align: center;
            padding: 20px;
            color: #28a745;
            font-weight: 500;
        }

        .system-status {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .system-status h2 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 1.5em;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-dot.active {
            background: #28a745;
        }

        .profile-reminder {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .reminder-content {
            text-align: center;
        }

        .reminder-content h3 {
            margin: 0 0 10px 0;
            font-size: 1.3em;
        }

        .reminder-content p {
            margin: 0 0 20px 0;
            opacity: 0.9;
        }

        .reminder-btn {
            background: white;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            display: inline-block;
        }

        .reminder-btn:hover {
            background: #f8f9fa;
        }

        @media (max-width: 768px) {
            .stats-overview {
                grid-template-columns: 1fr 1fr;
            }
            
            .action-grid {
                grid-template-columns: 1fr;
            }
            
            .activity-header {
                flex-direction: column;
                gap: 15px;
                align-items: start;
            }
            
            .refresh-btn {
                align-self: stretch;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-overview {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 20px;
            }
        }
    </style>
</body>
</html>